Deck = [
  { data: 'A ♥', value: 1 },
  { data: 'A ♦', value: 1 },
  { data: 'A ♣', value: 1 },
  { data: 'A ♠', value: 1 },
  { data: '2 ♥', value: 2 },
  { data: '2 ♦', value: 2 },
  { data: '2 ♣', value: 2 },
  { data: '2 ♠', value: 2 },
  { data: '3 ♥', value: 3 },
  { data: '3 ♦', value: 3 },
  { data: '3 ♣', value: 3 },
  { data: '3 ♠', value: 3 },
  { data: '4 ♥', value: 4 },
  { data: '4 ♦', value: 4 },
  { data: '4 ♣', value: 4 },
  { data: '4 ♠', value: 4 },
  { data: '5 ♥', value: 5 },
  { data: '5 ♦', value: 5 },
  { data: '5 ♣', value: 5 },
  { data: '5 ♠', value: 5 },
  { data: '6 ♥', value: 6 },
  { data: '6 ♦', value: 6 },
  { data: '6 ♣', value: 6 },
  { data: '6 ♠', value: 6 },
  { data: '7 ♥', value: 7 },
  { data: '7 ♦', value: 7 },
  { data: '7 ♣', value: 7 },
  { data: '7 ♠', value: 7 },
  { data: '8 ♥', value: 8 },
  { data: '8 ♦', value: 8 },
  { data: '8 ♣', value: 8 },
  { data: '8 ♠', value: 8 },
  { data: '9 ♥', value: 9 },
  { data: '9 ♦', value: 9 },
  { data: '9 ♣', value: 9 },
  { data: '9 ♠', value: 9 },
  { data: '10 ♥', value: 10 },
  { data: '10 ♦', value: 10 },
  { data: '10 ♣', value: 10 },
  { data: '10 ♠', value: 10 },
  { data: 'J ♥', value: 10 },
  { data: 'J ♦', value: 10 },
  { data: 'J ♣', value: 10 },
  { data: 'J ♠', value: 10 },
  { data: 'Q ♥', value: 10 },
  { data: 'Q ♦', value: 10 },
  { data: 'Q ♣', value: 10 },
  { data: 'Q ♠', value: 10 },
  { data: 'K ♥', value: 10 },
  { data: 'K ♦', value: 10 },
  { data: 'K ♣', value: 10 },
  { data: 'K ♠', value: 10 }
]

const DECK = [
  { data: 'A ♥', value: 1 },
  { data: 'A ♦', value: 1 },
  { data: 'A ♣', value: 1 },
  { data: 'A ♠', value: 1 },
  { data: '2 ♥', value: 2 },
  { data: '2 ♦', value: 2 },
  { data: '2 ♣', value: 2 },
  { data: '2 ♠', value: 2 },
  { data: '3 ♥', value: 3 },
  { data: '3 ♦', value: 3 },
  { data: '3 ♣', value: 3 },
  { data: '3 ♠', value: 3 },
  { data: '4 ♥', value: 4 },
  { data: '4 ♦', value: 4 },
  { data: '4 ♣', value: 4 },
  { data: '4 ♠', value: 4 },
  { data: '5 ♥', value: 5 },
  { data: '5 ♦', value: 5 },
  { data: '5 ♣', value: 5 },
  { data: '5 ♠', value: 5 },
  { data: '6 ♥', value: 6 },
  { data: '6 ♦', value: 6 },
  { data: '6 ♣', value: 6 },
  { data: '6 ♠', value: 6 },
  { data: '7 ♥', value: 7 },
  { data: '7 ♦', value: 7 },
  { data: '7 ♣', value: 7 },
  { data: '7 ♠', value: 7 },
  { data: '8 ♥', value: 8 },
  { data: '8 ♦', value: 8 },
  { data: '8 ♣', value: 8 },
  { data: '8 ♠', value: 8 },
  { data: '9 ♥', value: 9 },
  { data: '9 ♦', value: 9 },
  { data: '9 ♣', value: 9 },
  { data: '9 ♠', value: 9 },
  { data: '10 ♥', value: 10 },
  { data: '10 ♦', value: 10 },
  { data: '10 ♣', value: 10 },
  { data: '10 ♠', value: 10 },
  { data: 'J ♥', value: 10 },
  { data: 'J ♦', value: 10 },
  { data: 'J ♣', value: 10 },
  { data: 'J ♠', value: 10 },
  { data: 'Q ♥', value: 10 },
  { data: 'Q ♦', value: 10 },
  { data: 'Q ♣', value: 10 },
  { data: 'Q ♠', value: 10 },
  { data: 'K ♥', value: 10 },
  { data: 'K ♦', value: 10 },
  { data: 'K ♣', value: 10 },
  { data: 'K ♠', value: 10 }
]

var DeckProb = [
  { data: 'A ♥', value: 1 },
  { data: 'A ♦', value: 1 },
  { data: 'A ♣', value: 1 },
  { data: 'A ♠', value: 1 },
  { data: '2 ♥', value: 2 },
  { data: '2 ♦', value: 2 },
  { data: '2 ♣', value: 2 },
  { data: '2 ♠', value: 2 },
  { data: '3 ♥', value: 3 },
  { data: '3 ♦', value: 3 },
  { data: '3 ♣', value: 3 },
  { data: '3 ♠', value: 3 },
  { data: '4 ♥', value: 4 },
  { data: '4 ♦', value: 4 },
  { data: '4 ♣', value: 4 },
  { data: '4 ♠', value: 4 },
  { data: '5 ♥', value: 5 },
  { data: '5 ♦', value: 5 },
  { data: '5 ♣', value: 5 },
  { data: '5 ♠', value: 5 }
]

const minPoints = 16
const histProb = []
const results = []

var firstPlayerNumber = 0;

var PlayerOne = {
  id: 'P1',
  cards: [],
  points: 0,
  probabilty: 0
}

var PlayerTwo = {
  id: 'P2',
  cards: [],
  points: 0,
  probabilty: 0
}

function restartDeck() {
  Deck = DECK
}

function resetPlayer (player) {
  player.points = 0
  player.cards = []
  restartDeck()
  init()
}

function sortNumber(quantity) {
  return Math.floor(Math.random() * quantity + 1)
}

function firstPlayer(sort, quantity) {
  return sort(quantity)
}

function validatePoints(player) {
  return player.points < minPoints
}

function incrementProb(key, probabilty) {
  let prob = []
  prob.push(localStorage.getItem(key))
  prob.push(probabilty)

  localStorage.setItem('prob', prob)
}

function write (id, obj, end) {
  let s = ''
  for (var i = 0; i < obj.cards.length; i++) {
    if (obj.id == 'P1' && !end ) {
      console.log(`teste`);
      s += '| X'
    } else {
      console.log(`teste 2`);
      s += '| ' + obj.cards[i].data
    }
  }

  if (obj.id == 'P1' && !end) {
    document.getElementById(id).innerHTML = s + '|  Pontos: x '
  } else {
    document.getElementById(id).innerHTML = s + '|  Pontos: ' + obj.points
  }

}

function setPlayersCards(player, length, deck, sort, quantity) {
  for (let i = 0; i < length; i++) {
    try {
      //pode dar um erro quando tenta pegar uma 'pos' que nn existe no deck
      let pos = sort(quantity)
      player.cards.push(deck[pos])
      player.points += deck[pos].value
      deck.splice(pos, 1)
    }
    catch (ex) {
      i--
    }
  }
  return player
}

function getCard(player, length, deck, func, quantity) {
  setPlayersCards(player, length, deck, func, quantity)
}

function avg(key) {
  let total = 0
  let prob
  prob = (localStorage.getItem(key).split(','))

  for (let i = 0; i < prob.length; i++) {
    total += prob[i] * 1
  }

  return total / prob.length
}

function robotTurn(player, length, deck, sort, quantity) {
  let mark
  let med
  let cardsN = []

  while (validatePoints(player)) {
    getCard(player, length, deck, sort, quantity)
  }

  for (let i = 0; i < player.cards.length; i++)
    for (let j = 0; j < DeckProb.length; j++)
      if (DeckProb[j] == player.cards[i])
        DeckProb.splice(j, 1)

  mark = 21 - player.points

  for (let w = 0; w < DeckProb.length; w++)
    if (DeckProb[w].value <= mark)
      cardsN.push(DeckProb[w])

  let probabilty = cardsN.length / (52 - player.cards.length)

  incrementProb('prob', probabilty)
  med = avg('prob')

  if (probabilty >= med) {
    getCard(player, length, deck, sort, quantity)
    robotTurn(player, length, deck, sort, quantity)
  }

  document.getElementById('play').disabled = false

}

function humanTurn(id) {
  getCard(PlayerTwo, 1, Deck, sortNumber, Deck.length)
  write('player2', PlayerTwo, true)
  document.getElementById(id).disabled = validatePoints(PlayerTwo)
}

function comparePoints(player1, player2) {
  let winner
  if (player1.points > 21 && player2.points > 21 || player1.points === player2.points) {
    winner = 0
  } else if (player1.points > 21) {
    winner = 2
  } else if (player2.points > 21) {
    winner = 1
  } else if (player1.points > player2.points) {
    winner = 1
  } else {
    winner = 2
  }

  write('player1', player1, true)
  write('player2', player2, true)

  document.getElementById('winner').innerHTML = 'teste'


  return winner
}



function init () {
  setPlayersCards(PlayerOne, 2, Deck, sortNumber, 52)
  setPlayersCards(PlayerTwo, 2, Deck, sortNumber, 52)

  robotTurn(PlayerOne, 1, Deck, sortNumber, Deck.length)

  write('player1', PlayerOne, false)
  write('player2', PlayerTwo, false)
}
